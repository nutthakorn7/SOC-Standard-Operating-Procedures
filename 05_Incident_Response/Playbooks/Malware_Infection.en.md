# Playbook: Malware Infection

**ID**: PB-03
**Severity**: Medium/High | **Category**: Endpoint Security
**MITRE ATT&CK**: [T1204](https://attack.mitre.org/techniques/T1204/) (User Execution), [T1059](https://attack.mitre.org/techniques/T1059/) (Command and Scripting Interpreter)
**Trigger**: EDR alert, AV detection, SIEM correlation, User report

### Malware Analysis Pipeline

```mermaid
graph LR
    Hash["#ï¸âƒ£ Hash"] --> VT["ðŸ” VirusTotal"]
    VT --> Known{"âœ… Known?"}
    Known -->|Yes| Report["ðŸ“‹ Use TI report"]
    Known -->|No| Sandbox["ðŸ§ª Sandbox"]
    Sandbox --> Static["ðŸ“ Static Analysis"]
    Static --> Dynamic["â–¶ï¸ Dynamic Analysis"]
    Dynamic --> IOC["ðŸŽ¯ Extract IOCs"]
    style Hash fill:#3498db,color:#fff
    style Sandbox fill:#e74c3c,color:#fff
    style IOC fill:#27ae60,color:#fff
```

### Containment Workflow

```mermaid
sequenceDiagram
    participant EDR
    participant SOC
    participant FW as Firewall
    participant SIEM
    EDR->>SOC: ðŸš¨ Malware detected
    SOC->>EDR: Isolate host
    SOC->>EDR: Block hash (org-wide)
    SOC->>FW: Block C2 IP/domain
    SOC->>SIEM: Sweep IOCs org-wide
    SIEM-->>SOC: Results (additional hosts?)
```

---

## Decision Flow

```mermaid
graph TD
    Alert["ðŸš¨ AV/EDR Alert"] --> Verify{"ðŸ“ File Still Exists?"}
    Verify -->|No| AutoClean["AV Auto-Cleaned"]
    Verify -->|Yes| Hash["ðŸ” Check Hash"]
    AutoClean --> Review["Review: Was it Fully Cleaned?"]
    Review -->|Yes + No Persistence| Close["Close as Resolved"]
    Review -->|Uncertain| Hash
    Hash -->|Known Malware| Type{"What Type?"}
    Hash -->|Unknown| Sandbox["ðŸ§ª Sandbox Analysis"]
    Sandbox -->|Malicious| Type
    Sandbox -->|Benign| FP["False Positive"]
    Type -->|Infostealer| FullResponse["ðŸš¨ Full Response + Credential Reset"]
    Type -->|RAT/Backdoor| FullResponse
    Type -->|Adware/PUP| Limited["âš ï¸ Remove + Monitor"]
    Type -->|Ransomware| Ransomware["â†’ PB-02 Ransomware"]
    FullResponse --> Isolate["ðŸ”Œ Isolate & Eradicate"]
```

---

## 1. Analysis (Triage)

### 1.1 Initial Checks

| # | Check | How | Done |
|:---:|:---|:---|:---:|
| 1 | Verify file path | EDR console â€” is it in `%TEMP%`, `Downloads`, `System32`? | â˜ |
| 2 | Check file hash | VirusTotal, ThreatFox â€” known malware? | â˜ |
| 3 | Identify user | Who executed/downloaded the file? | â˜ |
| 4 | Determine delivery method | Email attachment, web download, USB? | â˜ |
| 5 | Check execution | Did the file execute or just land on disk? | â˜ |

### 1.2 Malware Classification

| Type | Risk | Additional Actions |
|:---|:---|:---|
| **Ransomware** | Critical | Escalate to [PB-02](Ransomware.en.md) immediately |
| **RAT / Backdoor** | High | Full IR â€” check C2, lateral movement |
| **Infostealer** | High | Reset all user credentials, check exfil |
| **Trojan Dropper** | High | Find all dropped payloads |
| **Cryptominer** | Medium | Remove, check for persistence |
| **Adware / PUP** | Low | Remove, tune AV rule |

### 1.3 Scope Assessment

- [ ] Any other hosts with the same file hash?
- [ ] Any network connections from the malware (C2)?
- [ ] Signs of lateral movement from this host?
- [ ] Any data exfiltration indicators?

---

## 2. Containment

| # | Action | Tool | Done |
|:---:|:---|:---|:---:|
| 1 | Network isolate the host | EDR | â˜ |
| 2 | Kill malicious process(es) | EDR / Task Manager | â˜ |
| 3 | Block file hash across all endpoints | EDR global blacklist | â˜ |
| 4 | Block C2 IP/domain at firewall/proxy | Firewall, Proxy | â˜ |
| 5 | Disable user account (if credential theft suspected) | AD / IdP | â˜ |

---

## 3. Eradication

| # | Action | Done |
|:---:|:---|:---:|
| 1 | Delete malicious file(s) from disk | â˜ |
| 2 | Remove persistence mechanisms: | |
|   | - Registry Run keys (`HKCU\...\Run`, `HKLM\...\Run`) | â˜ |
|   | - Scheduled Tasks | â˜ |
|   | - Startup folder shortcuts | â˜ |
|   | - Services | â˜ |
|   | - WMI event subscriptions | â˜ |
| 3 | Run full system AV/EDR scan | â˜ |
| 4 | Check for additional dropped files | â˜ |
| 5 | Verify no rootkits (if RAT/backdoor) | â˜ |

---

## 4. Recovery

| # | Action | Done |
|:---:|:---|:---:|
| 1 | Verify endpoint is clean (no alerts for 24h) | â˜ |
| 2 | Un-isolate host from network | â˜ |
| 3 | Reset user credentials (if Infostealer) | â˜ |
| 4 | Monitor endpoint for 48 hours post-recovery | â˜ |
| 5 | Confirm user awareness (how was it delivered?) | â˜ |

---

## 5. IoC Collection

| Type | Value | Source |
|:---|:---|:---|
| File Name | | EDR / AV |
| File Path | | EDR |
| File Hash (SHA256) | | EDR / Sandbox |
| C2 IP/Domain | | Network logs |
| Process Name | | EDR |
| Parent Process | | EDR |
| Delivery Method | | Email / Proxy logs |
| Dropped Files | | Sandbox |

---

## 6. Escalation Criteria

| Condition | Escalate To |
|:---|:---|
| Ransomware variant | [PB-02 Ransomware](Ransomware.en.md) |
| RAT/backdoor with active C2 | Tier 2 + Threat Hunt |
| Multiple hosts infected | SOC Lead â€” Major Incident |
| Infostealer confirmed | Tier 2 + Identity team |
| Data exfiltration evidence | [PB-08 Data Exfiltration](Data_Exfiltration.en.md) |

---

## 7. Post-Incident

- [ ] Verify all malware artifacts have been removed from affected hosts
- [ ] Update antivirus / EDR signatures with new indicators
- [ ] Submit samples to threat intelligence platforms (VirusTotal, MWDB)
- [ ] Create Sigma detection rule for observed malware behavior
- [ ] Review endpoint hardening (disable macros, restrict PowerShell)
- [ ] Conduct user awareness training if initial access was via phishing
- [ ] Review application control policies for bypassed executables
- [ ] Document findings in [Incident Report](../../templates/incident_report.en.md)

---

### Malware Analysis Pipeline

```mermaid
graph LR
    Sample["ðŸ¦  Sample"] --> Static["ðŸ“‹ Static Analysis"]
    Static --> Sandbox["ðŸ–ï¸ Sandbox"]
    Sandbox --> IOC["ðŸ” Extract IOCs"]
    IOC --> TI["ðŸ“Š Threat Intel"]
    TI --> Block["ðŸ”’ Block"]
    Block --> Hunt["ðŸŽ¯ Hunt across org"]
    style Sample fill:#e74c3c,color:#fff
    style Block fill:#27ae60,color:#fff
```

### EDR Response Flow

```mermaid
sequenceDiagram
    participant EDR
    participant SOC
    participant Endpoint
    participant SIEM
    EDR->>SOC: ðŸš¨ Malware detected
    SOC->>EDR: Isolate host
    EDR->>Endpoint: ðŸ”’ Network isolated
    SOC->>EDR: Collect forensic data
    EDR-->>SOC: ðŸ“‹ Process tree + artifacts
    SOC->>SIEM: Add IOCs to blocklist
```

## Related Documents

- [IR Framework](../Framework.en.md)
- [Incident Report](../../templates/incident_report.en.md)
- [PB-02 Ransomware](Ransomware.en.md)
- [PB-08 Data Exfiltration](Data_Exfiltration.en.md)
- [PB-11 Suspicious Script](Suspicious_Script.en.md)

## References

- [MITRE ATT&CK T1204 â€” User Execution](https://attack.mitre.org/techniques/T1204/)
- [NIST SP 800-83r1 â€” Malware Incident Prevention and Handling](https://csrc.nist.gov/publications/detail/sp/800-83/rev-1/final)
